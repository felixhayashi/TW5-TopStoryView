/*\
title: $:/plugins/felixhayashi/topstoryview/top.js
type: application/javascript
module-type: storyview

Views the story as a linear sequence

@preserve

\*/
(function(){"use strict";var t=require("$:/plugins/felixhayashi/topstoryview/config.js").config;var e="cubic-bezier(0.645, 0.045, 0.355, 1)";var i=function(e){this.listWidget=e;this.pageScroller=new $tw.utils.PageScroller;this.pageScroller.scrollIntoView=this.scrollIntoView;this.pageScroller.storyRiverElement=document.getElementsByClassName(t.classNames.storyRiver)[0];this.pageScroller.backDropElement=document.getElementsByClassName(t.classNames.backDrop)[0];var i=$tw.wiki.getTiddler(t.references.scrollOffsetStore);this.pageScroller.offsetTop=i?parseInt(i.fields.text):71;var i=$tw.wiki.getTiddler(t.references.navigateToBehaviour);this.isMoveToTopNavigation=i?i.fields.text==="insert":false;this.lastFrame=null;this.handleChange()};i.prototype.navigateTo=function(t){console.log(t);var e=this.listWidget.findListItem(0,t.title);if(e===undefined){return}var i=this.listWidget.children[e];var o=i.findFirstDomNode();if(o instanceof Element){if(this.isMoveToTopNavigation){this.putAtTop(o)}this.pageScroller.scrollIntoView(o)}};i.prototype.scrollIntoView=function(t){var e=$tw.utils.getAnimationDuration();this.cancelScroll();this.startTime=Date.now();var i=$tw.utils.getScrollPosition();var o=t.getBoundingClientRect(),r={left:o.left+i.x,top:o.top+i.y,width:o.width,height:o.height};var n=function(t,e,i,o){if(t<=i){return t}else if(e<o&&i<t+e-o){return t+e-o}else if(i<t){return t}else{return i}},s=n(r.left,r.width,i.x,window.innerWidth),a=r.top-this.offsetTop;if(s!==i.x||a!==i.y){var l=this,m;m=function(){var t;if(e<=0){t=1}else{t=(Date.now()-l.startTime)/e}if(t>=1){l.cancelScroll();t=1}t=$tw.utils.slowInSlowOut(t);window.scrollTo(i.x+(s-i.x)*t,i.y+(a-i.y)*t);if(t<1){l.idRequestFrame=l.requestAnimationFrame.call(window,m)}};m()}};i.prototype.handleChange=function(e,i){var o=this.pageScroller.storyRiverElement;var r=o.getElementsByClassName(t.classNames.tiddlerFrame);var n=r[r.length-1];if(n&&this.lastFrame!==n){var s=n.getBoundingClientRect();var a=window.innerHeight;if(s.height<a){o.style["paddingBottom"]=a-s.height+"px"}else{o.style["paddingBottom"]=""}}this.lastFrame=n;$tw.wiki.addTiddler(new $tw.Tiddler({title:t.references.refreshTrigger}))};i.prototype.insert=function(t){return this.insertTarget(t.findFirstDomNode())};i.prototype.insertTarget=function(t){if(!(t instanceof Element))return;this.putAtTop(t);this.startInsertAnimation(t,function(){this.handleChange("insert",t)}.bind(this))};i.prototype.putAtTop=function(t){var e=this.pageScroller.storyRiverElement;e.insertBefore(t,e.firstElementChild.nextSibling)};i.prototype.remove=function(e){var i=e.findFirstDomNode();if(!(i instanceof Element)){e.removeChildDomNodes();return}this.startRemoveAnimation(e,i,function(){e.removeChildDomNodes();this.handleChange("remove",i);if(this.lastFrame){if(this.lastFrame===i){var o=t.fn.extractTitleFromFrame(i,t.classNames.tiddlerFrame,t.classNames.tiddlerTitle);if(!$tw.wiki.findDraft(o)){this.pageScroller.scrollIntoView(this.lastFrame)}}}}.bind(this))};i.prototype.startInsertAnimation=function(t,i){var o=$tw.utils.getAnimationDuration();var r=window.getComputedStyle(t),n=parseInt(r.marginBottom,10),s=parseInt(r.marginTop,10),a=t.offsetHeight+s;setTimeout(function(){$tw.utils.setStyle(t,[{transition:"none"},{marginBottom:""}]);i()},o);$tw.utils.setStyle(t,[{transition:"none"},{marginBottom:-a+"px"},{opacity:"0.0"}]);$tw.utils.forceLayout(t);$tw.utils.setStyle(t,[{transition:"opacity "+o+"ms "+e+", "+"margin-bottom "+o+"ms "+e},{marginBottom:n+"px"},{opacity:"1.0"}])};i.prototype.startRemoveAnimation=function(t,i,o){var r=$tw.utils.getAnimationDuration();var n=i.offsetWidth,s=window.getComputedStyle(i),a=parseInt(s.marginBottom,10),l=parseInt(s.marginTop,10),m=i.offsetHeight+l;setTimeout(o,r);$tw.utils.setStyle(i,[{transition:"none"},{transform:"translateX(0px)"},{marginBottom:a+"px"},{opacity:"1.0"}]);$tw.utils.forceLayout(i);$tw.utils.setStyle(i,[{transition:$tw.utils.roundTripPropertyName("transform")+" "+r+"ms "+e+", "+"opacity "+r+"ms "+e+", "+"margin-bottom "+r+"ms "+e},{transform:"translateX(-"+n+"px)"},{marginBottom:-m+"px"},{opacity:"0.0"}])};exports.top=i})();