/*\
title: $:/plugins/felixhayashi/topstoryview/top.js
type: application/javascript
module-type: storyview

Views the story as a linear sequence

@preserve

\*/
(function(){"use strict";var t=require("$:/plugins/felixhayashi/topstoryview/config.js").config;var e="cubic-bezier(0.645, 0.045, 0.355, 1)";var i=function(e){this.listWidget=e;this.pageScroller=new $tw.utils.PageScroller;this.pageScroller.scrollIntoView=this.scrollIntoView;this.pageScroller.storyRiverElement=document.getElementsByClassName(t.classNames.storyRiver)[0];this.pageScroller.backDropElement=document.getElementsByClassName(t.classNames.backDrop)[0];var i=$tw.wiki.getTiddler(t.references.scrollOffsetStore);this.pageScroller.offsetTop=i?parseInt(i.fields.text):71;this.lastFrame=null;this.handleChange()};i.prototype.navigateTo=function(t){var e=this.listWidget.findListItem(0,t.title);if(e===undefined){return}var i=this.listWidget.children[e],r=i.findFirstDomNode();if(r instanceof Element){this.pageScroller.scrollIntoView(r)}};i.prototype.scrollIntoView=function(t){var e=$tw.utils.getAnimationDuration();this.cancelScroll();this.startTime=Date.now();var i=$tw.utils.getScrollPosition();var r=t.getBoundingClientRect(),o={left:r.left+i.x,top:r.top+i.y,width:r.width,height:r.height};var n=function(t,e,i,r){if(t<=i){return t}else if(e<r&&i<t+e-r){return t+e-r}else if(i<t){return t}else{return i}},s=n(o.left,o.width,i.x,window.innerWidth),a=o.top-this.offsetTop;if(s!==i.x||a!==i.y){var l=this,m;m=function(){var t;if(e<=0){t=1}else{t=(Date.now()-l.startTime)/e}if(t>=1){l.cancelScroll();t=1}t=$tw.utils.slowInSlowOut(t);window.scrollTo(i.x+(s-i.x)*t,i.y+(a-i.y)*t);if(t<1){l.idRequestFrame=l.requestAnimationFrame.call(window,m)}};m()}};i.prototype.handleChange=function(e,i){var r=this.pageScroller.storyRiverElement;var o=r.getElementsByClassName(t.classNames.tiddlerFrame);var n=o[o.length-1];if(n&&this.lastFrame!==n){var s=n.getBoundingClientRect();var a=window.innerHeight;if(s.height<a){r.style["paddingBottom"]=a-s.height+"px"}else{r.style["paddingBottom"]=""}}this.lastFrame=n;$tw.wiki.addTiddler(new $tw.Tiddler({title:t.references.refreshTrigger}))};i.prototype.insert=function(e){var i=e.findFirstDomNode();if(!(i instanceof Element)){return}var r=t.fn.extractTitleFromFrame(i,t.classNames.tiddlerFrame,t.classNames.tiddlerTitle);var o=$tw.wiki.getTiddler(r);if(o&&!o.isDraft()){var n=this.pageScroller.storyRiverElement;n.insertBefore(i,n.firstElementChild.nextSibling)}this.startInsertAnimation(i,function(){this.handleChange("insert",i)}.bind(this))};i.prototype.remove=function(t){console.log("hiwehi");var e=t.findFirstDomNode();if(!(e instanceof Element)){t.removeChildDomNodes();return}this.startRemoveAnimation(t,e,function(){var i=this.lastFrame===e;t.removeChildDomNodes();this.handleChange("remove",e);if(i&&this.lastFrame){this.pageScroller.scrollIntoView(this.lastFrame)}}.bind(this))};i.prototype.startInsertAnimation=function(t,i){var r=$tw.utils.getAnimationDuration();var o=window.getComputedStyle(t),n=parseInt(o.marginBottom,10),s=parseInt(o.marginTop,10),a=t.offsetHeight+s;setTimeout(function(){$tw.utils.setStyle(t,[{transition:"none"},{marginBottom:""}]);i()},r);$tw.utils.setStyle(t,[{transition:"none"},{marginBottom:-a+"px"},{opacity:"0.0"}]);$tw.utils.forceLayout(t);$tw.utils.setStyle(t,[{transition:"opacity "+r+"ms "+e+", "+"margin-bottom "+r+"ms "+e},{marginBottom:n+"px"},{opacity:"1.0"}])};i.prototype.startRemoveAnimation=function(t,i,r){var o=$tw.utils.getAnimationDuration();var n=i.offsetWidth,s=window.getComputedStyle(i),a=parseInt(s.marginBottom,10),l=parseInt(s.marginTop,10),m=i.offsetHeight+l;setTimeout(r,o);$tw.utils.setStyle(i,[{transition:"none"},{transform:"translateX(0px)"},{marginBottom:a+"px"},{opacity:"1.0"}]);$tw.utils.forceLayout(i);$tw.utils.setStyle(i,[{transition:$tw.utils.roundTripPropertyName("transform")+" "+o+"ms "+e+", "+"opacity "+o+"ms "+e+", "+"margin-bottom "+o+"ms "+e},{transform:"translateX(-"+n+"px)"},{marginBottom:-m+"px"},{opacity:"0.0"}])};exports.top=i})();